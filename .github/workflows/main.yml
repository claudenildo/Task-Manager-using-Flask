stages:
  - build
  - test
  - review
  - staging
  - security-test
  - deploy

variables:
  STAGING_URL: "http://staging.example.com"
  ZAP_URL: "http://zap-container:8080"

build:
  stage: build
  script:
    - echo "Construindo a aplicação..."
    - docker build -t my-app .

test:
  stage: test
  script:
    - echo "Executando testes automatizados..."
    - pytest tests/

review:
  stage: review
  script:
    - echo "Criando ambiente de revisão..."
    - docker-compose -f docker-compose.review.yml up -d
  only:
    - merge_requests

staging:
  stage: staging
  script:
    - echo "Fazendo deploy no ambiente de stage..."
    - docker-compose -f docker-compose.stage.yml up -d
  only:
    - main

security-test:
  stage: security-test
  script:
    - echo "Rodando OWASP ZAP no ambiente de stage..."
    - docker run --rm -t ghcr.io/zaproxy/zaproxy:stable zap.sh -quickurl "$STAGING_URL" -quickout zap_report.html
    - echo "Relatório gerado: zap_report.html"
  only:
    - main
  dependencies:
    - staging

deploy:
  stage: deploy
  script:
    - echo "Fazendo deploy para produção..."
    - docker-compose -f docker-compose.prod.yml up -d
  only:
    - tags
